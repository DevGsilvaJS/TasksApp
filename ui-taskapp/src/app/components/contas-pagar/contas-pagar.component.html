<div class="page-container">
  <div class="page-header">
    <h2>Contas a Pagar</h2>
    <button class="btn-primary" (click)="abrirFormularioNovo()" [disabled]="loading">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"></path>
      </svg>
      Nova Duplicata
    </button>
  </div>

  @if (error) {
    <div class="alert alert-error">
      {{ error }}
    </div>
  }

  @if (showForm) {
    <div class="modal-overlay" (click)="fecharFormulario()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editando ? 'Editar Duplicata' : 'Cadastrar Nova Duplicata' }}</h3>
          <button class="btn-close" (click)="fecharFormulario()">×</button>
        </div>
        <form (ngSubmit)="salvarDuplicata()" class="form">
          <div class="form-row">
            <div class="form-group">
              <label>Número *</label>
              <input type="number" [(ngModel)]="novaDuplicata.numero" name="numero" required>
            </div>
            <div class="form-group">
              <label>Data de Emissão *</label>
              <input type="date" [(ngModel)]="novaDuplicata.dataEmissao" name="dataEmissao" required>
            </div>
          </div>
          <div class="form-group">
            <label>Descrição da Despesa</label>
            <input type="text" [(ngModel)]="novaDuplicata.descricaoDespesa" name="descricaoDespesa" 
                   class="form-input" placeholder="Digite a descrição da despesa..." maxlength="500">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Número de Parcelas *</label>
              <input type="number" [(ngModel)]="novaDuplicata.numeroParcelas" name="numeroParcelas" required min="1" (change)="atualizarNumeroParcelas()">
            </div>
            <div class="form-group">
              <label>Valor Total *</label>
              <input type="number" [(ngModel)]="novaDuplicata.valorTotal" name="valorTotal" required min="0.01" step="0.01" (change)="atualizarValorTotal()">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Multa</label>
              <input type="number" [(ngModel)]="novaDuplicata.multa" name="multa" min="0" step="0.01" (change)="atualizarMultaJuros()">
            </div>
            <div class="form-group">
              <label>Juros</label>
              <input type="number" [(ngModel)]="novaDuplicata.juros" name="juros" min="0" step="0.01" (change)="atualizarMultaJuros()">
            </div>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" [(ngModel)]="gerarParcelasManual" (ngModelChange)="toggleGerarParcelasManual()" name="gerarParcelasManual">
              Gerar parcelas manualmente (preencher datas de vencimento individualmente)
            </label>
          </div>
          @if (!gerarParcelasManual) {
            <div class="form-group">
              <label>Data Primeiro Vencimento *</label>
              <input type="date" [(ngModel)]="novaDuplicata.dataPrimeiroVencimento" name="dataPrimeiroVencimento" required>
            </div>
          }
          @if (gerarParcelasManual && parcelasManuais.length > 0) {
            <div class="parcelas-section">
              <h4>Parcelas</h4>
              <div class="parcelas-container">
                @for (parcela of parcelasManuais; track parcela.numeroParcela) {
                  <div class="parcela-item">
                    <div class="parcela-header">
                      <strong>Parcela {{ parcela.numeroParcela }}</strong>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Valor *</label>
                        <input type="number" [(ngModel)]="parcela.valor" name="valor{{parcela.numeroParcela}}" required min="0.01" step="0.01">
                      </div>
                      <div class="form-group">
                        <label>Data de Vencimento *</label>
                        <input type="date" [(ngModel)]="parcela.vencimento" name="vencimento{{parcela.numeroParcela}}" required>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Multa</label>
                        <input type="number" [(ngModel)]="parcela.multa" name="multa{{parcela.numeroParcela}}" min="0" step="0.01">
                      </div>
                      <div class="form-group">
                        <label>Juros</label>
                        <input type="number" [(ngModel)]="parcela.juros" name="juros{{parcela.numeroParcela}}" min="0" step="0.01">
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="fecharFormulario()">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="loading">
              {{ loading ? 'Salvando...' : 'Salvar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (showParcelas && duplicataSelecionada) {
    <div class="modal-overlay" (click)="fecharParcelas()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Parcelas - Duplicata #{{ duplicataSelecionada.numero }}</h3>
          <button class="btn-close" (click)="fecharParcelas()">×</button>
        </div>
        <div class="parcelas-info">
          <div class="info-item">
            <span class="info-label">Valor Total:</span>
            <span class="info-value">{{ formatarMoeda(duplicataSelecionada.valorTotal) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Valor Pago:</span>
            <span class="info-value status-paga">{{ formatarMoeda(duplicataSelecionada.valorPago) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Valor Pendente:</span>
            <span class="info-value status-pendente">{{ formatarMoeda(duplicataSelecionada.valorPendente) }}</span>
          </div>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Parcela</th>
                <th>Valor</th>
                <th>Multa</th>
                <th>Juros</th>
                <th>Valor Total</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>Data Pagamento</th>
                <th class="actions-column">Ações</th>
              </tr>
            </thead>
            <tbody>
              @for (parcela of duplicataSelecionada.parcelas; track parcela.parcelaId) {
                <tr>
                  <td>{{ parcela.numeroParcela }}</td>
                  <td>{{ formatarMoeda(parcela.valor) }}</td>
                  <td>{{ formatarMoeda(parcela.multa) }}</td>
                  <td>{{ formatarMoeda(parcela.juros) }}</td>
                  <td>{{ formatarMoeda(parcela.valorTotal) }}</td>
                  <td>{{ formatarData(parcela.vencimento) }}</td>
                  <td>
                    <span class="status-badge" [ngClass]="getStatusClass(parcela.status)">
                      {{ parcela.status }}
                    </span>
                  </td>
                  <td>{{ parcela.dataPagamento ? formatarData(parcela.dataPagamento) : '-' }}</td>
                  <td class="actions-cell">
                    @if (parcela.status === 'Pendente') {
                      <button class="btn-baixar" (click)="baixarParcela(parcela)" title="Baixar Parcela" [disabled]="loading">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M9 11l3 3L22 4"></path>
                          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        Baixar
                      </button>
                    } @else {
                      <button class="btn-reativar" (click)="reativarParcela(parcela)" title="Reativar Parcela" [disabled]="loading">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                          <path d="M21 3v5h-5"></path>
                          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                          <path d="M3 21v-5h5"></path>
                        </svg>
                        Reativar
                      </button>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <div class="search-container">
    <input 
      type="text" 
      placeholder="Buscar por número ou data..." 
      [(ngModel)]="termoBusca"
      (input)="filtrarDuplicatas()"
      class="search-input">
  </div>

  @if (loading && duplicatas.length === 0) {
    <div class="loading">Carregando...</div>
  } @else if (duplicatasFiltradas.length === 0) {
    <div class="empty-state">
      <p>{{ termoBusca ? 'Nenhuma duplicata encontrada' : 'Nenhuma duplicata cadastrada' }}</p>
    </div>
  } @else {
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Data Emissão</th>
            <th>Descrição da Despesa</th>
            <th>Parcelas</th>
            <th>Valor Total</th>
            <th>Valor Pago</th>
            <th>Valor Pendente</th>
            <th class="actions-column">Ações</th>
          </tr>
        </thead>
        <tbody>
          @for (duplicata of duplicatasFiltradas; track duplicata.duplicataId) {
            <tr>
              <td>{{ duplicata.numero }}</td>
              <td>{{ formatarData(duplicata.dataEmissao) }}</td>
              <td>{{ duplicata.descricaoDespesa || '-' }}</td>
              <td>{{ duplicata.numeroParcelas }}</td>
              <td>{{ formatarMoeda(duplicata.valorTotal) }}</td>
              <td class="status-paga">{{ formatarMoeda(duplicata.valorPago) }}</td>
              <td class="status-pendente">{{ formatarMoeda(duplicata.valorPendente) }}</td>
              <td class="actions-cell">
                <button class="btn-view" (click)="abrirParcelas(duplicata)" title="Ver Parcelas">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  Parcelas
                </button>
                <button class="btn-edit" (click)="abrirFormularioEdicao(duplicata)" title="Editar" [disabled]="duplicata.valorPago > 0">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button class="btn-delete" (click)="excluirDuplicata(duplicata)" title="Excluir" [disabled]="duplicata.valorPago > 0">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
