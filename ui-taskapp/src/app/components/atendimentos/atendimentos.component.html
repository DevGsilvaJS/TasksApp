<div class="page-container">
  <div class="page-header">
    <h2>Atendimentos (Tarefas)</h2>
    <button class="btn-primary" (click)="abrirFormularioNovo()" [disabled]="loading">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"></path>
      </svg>
      Nova Tarefa
    </button>
  </div>

  @if (error) {
    <div class="alert alert-error">
      {{ error }}
    </div>
  }

  @if (showForm) {
    <div class="modal-overlay" (click)="fecharFormulario()">
      <div class="modal-content modal-tarefa" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editando ? 'Editar Tarefa' : 'Cadastrar Nova Tarefa' }}</h3>
          <button class="btn-close" (click)="fecharFormulario()">×</button>
        </div>
        <form (ngSubmit)="salvarTarefa()" class="form" enctype="multipart/form-data">
          <div class="form-row">
            <div class="form-group">
              <label>Título</label>
              <input type="text" [ngModel]="novoTarefa.titulo" (ngModelChange)="novoTarefa.titulo = $event.toUpperCase()" name="titulo" class="form-input" 
                     style="text-transform: uppercase;" placeholder="Digite o título da tarefa...">
            </div>
            <div class="form-group">
              <label>Cliente *</label>
              <select [(ngModel)]="novoTarefa.clienteId" name="clienteId" required class="form-select" [value]="novoTarefa.clienteId">
                <option [value]="0">Selecione um cliente</option>
                @for (cliente of clientes; track cliente.clienteId) {
                  <option [value]="cliente.clienteId">{{ cliente.codigo }} - {{ cliente.fantasia }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Protocolo</label>
              <input type="text" [ngModel]="novoTarefa.protocolo" (ngModelChange)="novoTarefa.protocolo = $event.toUpperCase()" name="protocolo" class="form-input" 
                     style="text-transform: uppercase;" maxlength="6" placeholder="000000">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Solicitante</label>
              <input type="text" [ngModel]="novoTarefa.solicitante" (ngModelChange)="novoTarefa.solicitante = $event.toUpperCase()" name="solicitante" class="form-input" 
                     style="text-transform: uppercase;" placeholder="Nome do solicitante...">
            </div>
            <div class="form-group">
              <label>Celular do Solicitante</label>
              <input type="text" [(ngModel)]="novoTarefa.celularSolicitante" name="celularSolicitante" 
                     (input)="aplicarMascaraCelular($event)" maxlength="15" 
                     class="form-input" placeholder="(11) 98327-0236">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select [(ngModel)]="novoTarefa.status" name="status" class="form-select" [value]="novoTarefa.status" (change)="onStatusChange($event)">
                @for (status of statusOptions; track status.value) {
                  <option [value]="status.value">{{ status.label }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Descrição/Anotação</label>
            <textarea 
              [ngModel]="novoTarefa.descricao" 
              (ngModelChange)="novoTarefa.descricao = $event.toUpperCase()"
              name="descricao" 
              class="form-textarea form-textarea-large"
              style="text-transform: uppercase;"
              rows="4"
              placeholder="Digite uma descrição ou anotação para esta tarefa..."></textarea>
          </div>
          <div class="form-group">
            <label>Imagens</label>
            <input 
              type="file" 
              (change)="onImagensSelecionadas($event)" 
              multiple 
              accept="image/*"
              class="form-input">
            @if (previewImagens.length > 0) {
              <div class="imagens-preview">
                @for (preview of previewImagens; track $index) {
                  <div class="imagem-preview-item">
                    <img [src]="preview" alt="Preview">
                    <button type="button" class="btn-remover-imagem" (click)="removerImagem($index)">×</button>
                  </div>
                }
              </div>
            }
            @if (editando && tarefaEditando && tarefaEditando.imagens && tarefaEditando.imagens.length > 0) {
              <div class="imagens-existentes">
                <label>Imagens Existentes</label>
                <button type="button" class="btn-view-images" (click)="abrirImagens(tarefaEditando)">Ver Imagens ({{ tarefaEditando.imagens.length }})</button>
              </div>
            }
          </div>
          
          @if (editando && tarefaEditando && tarefaEditando.anotacoes && tarefaEditando.anotacoes.length > 0) {
            <div class="form-group anotacoes-preview">
              <label>Anotações Existentes</label>
              <div class="anotacoes-preview-list">
                @for (anotacao of tarefaEditando.anotacoes; track anotacao.anotacaoId) {
                  <div class="anotacao-preview-item">
                    <p>{{ anotacao.descricaoFormatada || anotacao.descricao }}</p>
                  </div>
                }
              </div>
            </div>
          }
          
          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="fecharFormulario()">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="loading">
              {{ loading ? 'Salvando...' : 'Salvar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <div class="search-container">
    <input 
      type="text" 
      placeholder="Buscar por protocolo, título, solicitante, cliente, usuário, status ou ID..." 
      [(ngModel)]="termoBusca"
      (input)="filtrarTarefas()"
      class="search-input">
  </div>

  @if (loading && tarefas.length === 0) {
    <div class="loading">Carregando...</div>
  } @else if (tarefasFiltradas.length === 0) {
    <div class="empty-state">
      <p>{{ termoBusca ? 'Nenhuma tarefa encontrada' : 'Nenhuma tarefa cadastrada' }}</p>
    </div>
  } @else {
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Protocolo</th>
            <th>Título</th>
            <th>Solicitante</th>
            <th>Celular</th>
            <th>Cliente</th>
            <th>Usuário</th>
            <th>Status</th>
            <th>Data Cadastro</th>
            <th>Data Conclusão</th>
            <th class="actions-column">Ações</th>
          </tr>
        </thead>
        <tbody>
          @for (tarefa of tarefasFiltradas; track tarefa.tarefaId) {
            <tr>
              <td>{{ tarefa.tarefaId }}</td>
              <td>{{ tarefa.protocolo || '-' }}</td>
              <td>{{ tarefa.titulo || '-' }}</td>
              <td>{{ tarefa.solicitante || '-' }}</td>
              <td>{{ tarefa.celularSolicitante || '-' }}</td>
              <td>{{ tarefa.clienteNome }}</td>
              <td>{{ tarefa.usuarioNome }}</td>
              <td>
                <span class="status-badge" [ngClass]="obterClasseStatus(tarefa.status)">
                  {{ tarefa.statusDescricao }}
                </span>
              </td>
              <td>{{ formatarData(tarefa.dataCadastro) }}</td>
              <td>{{ formatarData(tarefa.dataConclusao) }}</td>
              <td class="actions-cell">
                <div class="actions-group">
                  <button class="btn-notes" (click)="abrirAnotacoes(tarefa)" title="Anotações">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path>
                    </svg>
                    @if (tarefa.anotacoes && tarefa.anotacoes.length > 0) {
                      <span class="badge-count">{{ tarefa.anotacoes.length }}</span>
                    }
                  </button>
                  @if (tarefa.imagens && tarefa.imagens.length > 0) {
                    <button class="btn-images" (click)="abrirImagens(tarefa)" title="Ver Imagens">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <path d="M21 15l-5-5L5 21"></path>
                      </svg>
                      <span class="badge-count">{{ tarefa.imagens.length }}</span>
                    </button>
                  }
                  @if (tarefa.status !== StatusTarefa.Concluida) {
                    <button class="btn-status" (click)="alterarStatus(tarefa, StatusTarefa.Concluida)" title="Marcar como Concluída">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 6L9 17l-5-5"></path>
                      </svg>
                    </button>
                  }
                  @if (tarefa.status !== StatusTarefa.Cancelada) {
                    <button class="btn-status btn-cancel" (click)="alterarStatus(tarefa, StatusTarefa.Cancelada)" title="Cancelar">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                      </svg>
                    </button>
                  }
                  <button class="btn-edit" (click)="abrirFormularioEdicao(tarefa)" title="Editar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  <button class="btn-delete" (click)="excluirTarefa(tarefa)" title="Excluir">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  @if (showAnotacoes && tarefaSelecionada) {
    <div class="modal-overlay" (click)="fecharAnotacoes()">
      <div class="modal-content modal-anotacoes" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Anotações - Tarefa #{{ tarefaSelecionada.tarefaId }}</h3>
          <button class="btn-close" (click)="fecharAnotacoes()">×</button>
        </div>
        <div class="anotacoes-container">
          <div class="anotacao-form">
            <label>Nova Anotação</label>
            <div class="anotacao-input-group">
              <textarea 
                [(ngModel)]="novaAnotacao" 
                placeholder="Digite sua anotação aqui..."
                class="anotacao-textarea"
                rows="3"></textarea>
              <button class="btn-primary btn-inserir" (click)="inserirAnotacao()" [disabled]="!novaAnotacao.trim()">
                Inserir Anotação
              </button>
            </div>
          </div>
          <div class="anotacoes-list">
            <h4>Anotações</h4>
            @if (tarefaSelecionada.anotacoes && tarefaSelecionada.anotacoes.length > 0) {
              <div class="anotacoes-items">
                @for (anotacao of tarefaSelecionada.anotacoes; track anotacao.anotacaoId) {
                  <div class="anotacao-item">
                    <p>{{ anotacao.descricaoFormatada || anotacao.descricao }}</p>
                  </div>
                }
              </div>
            } @else {
              <p class="empty-anotacoes">Nenhuma anotação ainda</p>
            }
          </div>
        </div>
      </div>
    </div>
  }

  @if (showImagens && tarefaImagens) {
    <div class="modal-overlay" (click)="fecharImagens()">
      <div class="modal-content modal-imagens" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Imagens da Tarefa #{{ tarefaImagens.tarefaId }}</h3>
          <button class="btn-close" (click)="fecharImagens()">×</button>
        </div>
        <div class="carousel-container">
          @if (tarefaImagens.imagens && tarefaImagens.imagens.length > 0) {
            <div class="carousel-wrapper">
              <button class="carousel-btn carousel-btn-prev" (click)="imagemAnterior()" [disabled]="imagemAtualIndex === 0">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"></path>
                </svg>
              </button>
              <div class="carousel-image-container">
                <img [src]="'http://localhost:5132' + tarefaImagens.imagens[imagemAtualIndex].urlImagem" 
                     [alt]="'Imagem ' + (imagemAtualIndex + 1)" 
                     class="carousel-image"
                     (error)="onErroImagem($event)">
              </div>
              <button class="carousel-btn carousel-btn-next" (click)="proximaImagem()" [disabled]="imagemAtualIndex === tarefaImagens.imagens.length - 1">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </button>
            </div>
            <div class="carousel-indicators">
              <span>{{ imagemAtualIndex + 1 }} / {{ tarefaImagens.imagens.length }}</span>
            </div>
          } @else {
            <p>Nenhuma imagem disponível</p>
          }
        </div>
      </div>
    </div>
  }
</div>
